#!/bin/bash

# ==============================================================================
# 项目名称: LXD Container Management Agent
# 文件名称: lxd-agent.sh
# 运行环境: Debian 11+ / Ubuntu 20.04+ (需 Root 权限)
#
# [ 使用说明 ]
# 1. 上传此脚本到服务器:
#    wget https://raw.githubusercontent.com/您的用户名/仓库名/main/lxd-agent.sh
# 2. 赋予执行权限并运行:
#    chmod +x lxd-agent.sh && ./lxd-agent.sh
#
# [ 功能描述 ]
# - 自动初始化 LXD 环境与 ZFS/Btrfs 存储池
# - 配置 Nginx + mTLS 双向认证反向代理
# - 部署 Python FastAPI 后端，提供容器管理接口
# - 输出连接 Token 供前端面板对接
# ==============================================================================

# --- 全局配置 ---
AGENT_DIR="/opt/lxd-agent"
DATA_DIR="${AGENT_DIR}/data"
CERT_DIR="${AGENT_DIR}/certs"
PY_VENV="${AGENT_DIR}/.venv"
UVICORN_PORT="9042"      # 内部 API 端口
NGINX_HTTPS_PORT="443"   # 对外暴露端口 (mTLS 保护)

# --- 颜色定义 ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
PLAIN='\033[0m'

# 检查 Root 权限
[[ $EUID -ne 0 ]] && echo -e "${RED}错误：请使用 root 权限运行此脚本！${PLAIN}" && exit 1

# 1. 环境依赖安装
function install_env() {
    echo -e "${YELLOW}[1/5] 正在安装系统依赖...${PLAIN}"
    apt-get update -qq
    apt-get install -y -qq curl jq openssl nginx python3 python3-venv python3-pip ufw socat >/dev/null

    # 检查并安装 LXD
    if ! command -v lxc >/dev/null; then
        echo "    - 正在安装 LXD (Snap)..."
        snap install lxd
        # 初始化 LXD (默认配置，自动创建网桥和存储池)
        lxd init --auto
    else
        echo "    - LXD 已安装"
    fi
}

# 2. 生成安全证书 (mTLS)
function generate_certs() {
    echo -e "${YELLOW}[2/5] 生成 mTLS 双向认证证书...${PLAIN}"
    mkdir -p "${CERT_DIR}"
    
    # 获取公网/内网 IP 用于证书签名
    HOST_IP=$(hostname -I | awk '{print $1}')
    
    # (1) 生成 CA 根证书
    if [[ ! -f "${CERT_DIR}/ca.crt" ]]; then
        openssl genrsa -out "${CERT_DIR}/ca.key" 4096 2>/dev/null
        openssl req -x509 -new -nodes -key "${CERT_DIR}/ca.key" -days 3650 \
            -subj "/CN=LXD-Panel-CA" -out "${CERT_DIR}/ca.crt" 2>/dev/null
    fi

    # (2) 生成服务端证书 (Nginx用)
    if [[ ! -f "${CERT_DIR}/server.crt" ]]; then
        openssl genrsa -out "${CERT_DIR}/server.key" 2048 2>/dev/null
        # 创建扩展配置文件以支持 IP SAN
        cat > "${CERT_DIR}/server.cnf" <<EOF
[req]
default_bits = 2048
prompt = no
default_md = sha256
distinguished_name = dn
req_extensions = req_ext
[dn]
CN = ${HOST_IP}
[req_ext]
subjectAltName = IP:${HOST_IP}
EOF
        openssl req -new -key "${CERT_DIR}/server.key" -config "${CERT_DIR}/server.cnf" -out "${CERT_DIR}/server.csr" 2>/dev/null
        openssl x509 -req -in "${CERT_DIR}/server.csr" -CA "${CERT_DIR}/ca.crt" -CAkey "${CERT_DIR}/ca.key" -CAcreateserial \
            -out "${CERT_DIR}/server.crt" -days 3650 -extensions req_ext -extfile "${CERT_DIR}/server.cnf" 2>/dev/null
    fi

    # (3) 生成客户端证书 (面板用)
    if [[ ! -f "${CERT_DIR}/client.crt" ]]; then
        openssl genrsa -out "${CERT_DIR}/client.key" 2048 2>/dev/null
        openssl req -new -key "${CERT_DIR}/client.key" -subj "/CN=LXD-Panel-Client" -out "${CERT_DIR}/client.csr" 2>/dev/null
        openssl x509 -req -in "${CERT_DIR}/client.csr" -CA "${CERT_DIR}/ca.crt" -CAkey "${CERT_DIR}/ca.key" -CAcreateserial \
            -out "${CERT_DIR}/client.crt" -days 3650 2>/dev/null
    fi
    
    # 设置权限
    chmod 644 "${CERT_DIR}"/*.crt
    chmod 600 "${CERT_DIR}"/*.key
}

# 3. 部署 Python Agent
function deploy_app() {
    echo -e "${YELLOW}[3/5] 部署 LXD 控制 API...${PLAIN}"
    mkdir -p "${AGENT_DIR}" "${DATA_DIR}"
    
    # 生成本地通信密钥
    if [[ ! -f "${DATA_DIR}/agent.key" ]]; then
        openssl rand -hex 16 > "${DATA_DIR}/agent.key"
    fi

    # 写入依赖文件
    cat > "${AGENT_DIR}/requirements.txt" <<EOF
fastapi
uvicorn[standard]
pydantic
EOF

    # 写入核心业务代码 (使用 'EOF' 防止变量被 Shell 解析)
    cat > "${AGENT_DIR}/app.py" <<'PYTHON_EOF'
import os, subprocess, shlex
from typing import Optional
from fastapi import FastAPI, HTTPException, Request, Depends
from pydantic import BaseModel

# 读取本地密钥
try:
    with open("/opt/lxd-agent/data/agent.key") as f:
        APP_KEY = f.read().strip()
except:
    APP_KEY = "init_failed"

app = FastAPI()

# 简单的鉴权依赖
def verify_key(req: Request):
    if req.headers.get("X-API-Key") != APP_KEY:
        raise HTTPException(401, "Invalid API Key")

# 执行系统命令工具
def run_cmd(cmd: str):
    try:
        subprocess.check_call(shlex.split(cmd))
    except subprocess.CalledProcessError as e:
        raise HTTPException(500, f"Command Error: {cmd}")

# 请求模型
class ContainerReq(BaseModel):
    name: str
    image: str = "images:debian/11"
    cpu: int = 1
    memory: int = 512
    disk: int = 5
    ports: Optional[str] = None  # 格式: "10001:22,10002:80"
    ingress: Optional[int] = None # Mbps
    egress: Optional[int] = None # Mbps

@app.post("/create", dependencies=[Depends(verify_key)])
def create(c: ContainerReq):
    # 1. 创建容器
    run_cmd(f"lxc launch {c.image} {c.name}")
    
    # 2. 资源限制
    run_cmd(f"lxc config set {c.name} limits.cpu {c.cpu}")
    run_cmd(f"lxc config set {c.name} limits.memory {c.memory}MB")
    
    # 3. 磁盘限制 (尝试调整 root 设备大小)
    try:
        run_cmd(f"lxc config device set {c.name} root size {c.disk}GB")
    except:
        run_cmd(f"lxc config device override {c.name} root size={c.disk}GB")

    # 4. 网络带宽限制
    if c.ingress:
        run_cmd(f"lxc config device override {c.name} eth0 limits.ingress={c.ingress}Mbit")
    if c.egress:
        run_cmd(f"lxc config device override {c.name} eth0 limits.egress={c.egress}Mbit")

    # 5. 端口映射 (添加 Proxy 设备)
    if c.ports:
        for i, mapping in enumerate(c.ports.split(',')):
            if ':' in mapping:
                pub, priv = mapping.split(':')
                # 监听所有接口的 pub 端口，转发到容器的 priv 端口
                run_cmd(f"lxc config device add {c.name} proxy{i} proxy listen=tcp:0.0.0.0:{pub} connect=tcp:127.0.0.1:{priv}")

    return {"status": "created", "name": c.name}

@app.delete("/delete/{name}", dependencies=[Depends(verify_key)])
def delete(name: str):
    run_cmd(f"lxc delete {name} --force")
    return {"status": "deleted"}

@app.post("/action/{name}/{action}", dependencies=[Depends(verify_key)])
def action(name: str, action: str):
    if action not in ["start", "stop", "restart"]:
        raise HTTPException(400, "Invalid action")
    run_cmd(f"lxc {action} {name}")
    return {"status": "ok"}
PYTHON_EOF

    # 安装虚拟环境
    if [[ ! -d "${PY_VENV}" ]]; then
        python3 -m venv "${PY_VENV}"
        "${PY_VENV}/bin/pip" install -r "${AGENT_DIR}/requirements.txt" >/dev/null 2>&1
    fi
    
    # 配置 Systemd 服务
    cat > /etc/systemd/system/lxd-agent.service <<EOF
[Unit]
Description=LXD Control Agent API
After=network.target snap.lxd.daemon.service
[Service]
WorkingDirectory=${AGENT_DIR}
ExecStart=${PY_VENV}/bin/uvicorn app:app --host 127.0.0.1 --port ${UVICORN_PORT} --log-level error
Restart=always
[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable --now lxd-agent
}

# 4. 配置 Nginx 反向代理
function configure_nginx() {
    echo -e "${YELLOW}[4/5] 配置 Nginx 安全网关...${PLAIN}"
    
    # 获取 API KEY 用于 Nginx 转发验证 (可选)
    APP_KEY=$(cat "${DATA_DIR}/agent.key")

    cat > /etc/nginx/sites-available/lxd-agent <<EOF
server {
    listen ${NGINX_HTTPS_PORT} ssl;
    server_name _;
    
    # SSL 证书配置
    ssl_certificate      ${CERT_DIR}/server.crt;
    ssl_certificate_key  ${CERT_DIR}/server.key;
    
    # mTLS 客户端验证配置
    ssl_client_certificate ${CERT_DIR}/ca.crt;
    ssl_verify_client on;

    location / {
        proxy_pass http://127.0.0.1:${UVICORN_PORT};
        proxy_set_header X-API-Key "${APP_KEY}";
        proxy_set_header Host \$host;
    }
}
EOF
    ln -sf /etc/nginx/sites-available/lxd-agent /etc/nginx/sites-enabled/
    rm -f /etc/nginx/sites-enabled/default
    systemctl restart nginx
    
    # 放行防火墙
    ufw allow ${NGINX_HTTPS_PORT}/tcp >/dev/null 2>&1
    ufw allow 22/tcp >/dev/null 2>&1
}

# 5. 输出连接信息
function show_token() {
    HOST_IP=$(hostname -I | awk '{print $1}')
    API_URL="https://${HOST_IP}:${NGINX_HTTPS_PORT}"
    
    # 构造包含所有证书信息的 JSON
    JSON_DATA=$(jq -n \
                  --arg url "$API_URL" \
                  --arg ca "$(cat ${CERT_DIR}/ca.crt)" \
                  --arg cert "$(cat ${CERT_DIR}/client.crt)" \
                  --arg key "$(cat ${CERT_DIR}/client.key)" \
                  '{api_url: $url, ca_cert: $ca, client_cert: $cert, client_key: $key}')
    
    # Base64 编码
    TOKEN=$(echo "$JSON_DATA" | base64 -w0)
    
    echo -e "\n${GREEN}==============================================${PLAIN}"
    echo -e "${GREEN}   LXD Agent 安装成功！${PLAIN}"
    echo -e "${GREEN}==============================================${PLAIN}"
    echo -e "请复制下方的 [Token] 到控制面板添加此节点："
    echo ""
    echo -e "${YELLOW}${TOKEN}${PLAIN}"
    echo ""
}

# --- 主流程 ---
install_env
generate_certs
deploy_app
configure_nginx
show_token
